<html>
<style>
body {
  background-color: black;
}

#wrapper {
  width: 1200px;
  margin: 0 auto;
}

</style>
<body>
  <div id="wrapper">
    <canvas id="mycanvas" width="1200" height="800"></canvas>
  </div>

  <script src="../js/lodash.min.js"></script>
  <script src="../js/d3.v3.min.js"></script>
  <script src="../js/arrastre-util.js"></script>
  <script>


  // BOOLEAN

  // function drawAdditionalBackground(t) {
  //   if(Math.random() > additionalBackgroundChance(t)) {
  //     ctx.fillStyle = color(Math.random() - 1);
  //     ctx.shadowColor = 'white';
  //     ctx.shadowBlur = 30;
  //     ctx.globalAlpha = 0.1;
  //     drawCircle(ctx, 1200 * Math.random(), 800 * Math.random(), 50 + 150 * Math.random());
  //     ctx.shadowBlur = 0;
  //   }
  // }

  function poll() {
    d3.json('/playbackServer/api/data.json', function(err, json) {
      if(json === undefined) return;

      var data = getDataOfSkeleton(json, 0);
      // console.log(data);
      // data = data.slice(0, 8);
      ctx.globalAlpha = 0.5;

      ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
      ctx.fillRect(0, 0, width, height);


      // ctx.font = '15px sans-serif';

      var t = Date.now();

      // drawAdditionalBackground(t);


      var threshold = numCirclesScale(t);

      _.each(data, function(d, index) {
        // console.log(index);

        if(index > threshold)
          return;

        var drawAsBinary = Math.random() < chanceOfBinary(t);
        if(drawAsBinary) {

          // var fontSize = Math.random() * textScale(t) + 8;
          var fontSize = 12;
          ctx.font = 'bold ' + fontSize + 'px sans-serif';

          var binary = Math.round(scale(d)).toString(2);
          _.each(binary, function(bit) {
            var x = Math.random() * width;
            var y = Math.random() * height;
            ctx.fillStyle = bit === '1' ? 'blue' : '#888';

            ctx.fillText(bit, x, y);

            if(bit === '1') {
              ctx.shadowColor = 'white';
              ctx.shadowBlur = 30;
              ctx.globalAlpha = 0.1;
              drawCircle(ctx, x, y, 100 * Math.random());
              ctx.shadowBlur = 0;
              ctx.globalAlpha = 1;
            }

          });
        } else {
          var x = Math.random() * width;
          var y = Math.random() * height;

          ctx.fillStyle = color(d);

          drawCircle(ctx, x, y, 3);
        }
      });
    });
  }


  var width = 1200, height = 800;
  var startTime = Date.now();

  // var color = d3.scale.category20();
  var color = d3.scale.linear().domain([-1, 0]).range(['white', 'blue']);
  var scale = d3.scale.linear().domain([-3, 3]).range([0, 255]);

  // Duration 4:06
  var chanceOfBinary = d3.scale.linear().domain([startTime, startTime + 145000, startTime + 222000, startTime + 223000, startTime + 300000]).range([0, 0, 0.6, 0, 0]).clamp(true);
  var numCirclesScale = d3.scale.linear().domain([startTime, startTime + 135000, startTime + 222000, startTime + 223000, startTime + 300000]).range([0, 0, 4, 0, 0]).clamp(true);
  var textScale = d3.scale.linear().domain([startTime, startTime + 135000, startTime + 235000, startTime + 300000]).range([0, 0, 100, 100]).clamp(true);

  // var additionalBackgroundChance = d3.scale.linear().domain([startTime, startTime + 135000, startTime + 222000, startTime + 223000, startTime + 300000]).range([1, 0.98, 0.5, 0.98, 0.99]).clamp(true);

  var canvas = document.getElementById('mycanvas');
  var ctx = canvas.getContext('2d');

  ctx.fillStyle = "rgb(0,0,0)";
  ctx.fillRect(0, 0, width, height);

  // poll();
  setInterval(poll, 50);
 
</script>
</body>
